#include <cupy/carray.cuh>
#include <cub/cub.cuh>



{%- macro create_arg(name, type, dims, input=True) -%}
{%- if input %}const{% endif %} CArray<{{type}}, {{dims}}> {{name}}
{%- endmacro -%}

{#- Construct the kernel argument list #}
{%- set kernel_args = [
    create_arg("time_index", "int", 1),
    create_arg("antenna1", "int", 1),
    create_arg("antenna2", "int", 1) ] -%}

{%- if have_dde1 %}
{%- do kernel_args.append(create_arg("dde1", dde1_type, dde1_ndim)) %}
{%- endif %}
{%- if have_coh %}
{%- do kernel_args.append(create_arg("source_coh", coh_type, coh_ndim)) %}
{%- endif %}
{%- if have_dde2 %}
{%- do kernel_args.append(create_arg("dde2", dde2_type, dde2_ndim)) %}
{%- endif %}
{%- if have_die1 %}
{%- do kernel_args.append(create_arg("die1", die1_type, die1_ndim)) %}
{%- endif %}
{%- if have_base_vis %}
{%- do kernel_args.append(create_arg("base_vis", base_vis_type, base_vis_ndim)) %}
{%- endif %}
{%- if have_die2 %}
{%- do kernel_args.append(create_arg("die2", die2_type, die2_ndim)) %}
{%- endif %}

{%- do kernel_args.append(create_arg("output", out_type, out_ndim, False)) %}
{# End kernel argument list construction #}


{%- set have_ddes = have_dde1 and have_dde2 %}
{%- set have_dies = have_die1 and have_die2 %}

{#- Determine nrow and nchan variables #}
{%- if have_ddes %}
{%- set nchan = "dde1.shape()[3]" %}
{%- elif have_coh %}
{%- set nchan = "source_coh.shape()[2]" %}
{%- elif have_dies %}
{%- set nchan = "die1.shape()[2]" %}
{%- endif %}
{%- set nrow = "time_index.shape()[0]" %}
{#- end nrow and nchan variable determination #}

{#- Determine nsrc variable #}
{%- set do_coherencies = have_ddes or have_coh %}
{%- if have_ddes %}
{%- set nsrc = "dde1.shape()[0]" %}
{%- elif have_coh %}
{%- set nsrc = "source_coh.shape()[0]" %}
{%- endif %}
{#- End nsrc variable determination #}

// Create BlockLoad algorithm types
{%- if have_dde1 %}
typedef cub::BlockLoad<{{dde1_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadDDE1;
{%- endif %}

{%- if have_coh %}
typedef cub::BlockLoad<{{coh_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadCOH;
{%- endif %}

{%- if have_dde2 %}
typedef cub::BlockLoad<{{dde2_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadDDE2;
{%- endif %}

{%- if have_die1 %}
typedef cub::BlockLoad<{{die1_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadDIE1;
{%- endif %}

{%- if have_base_vis %}
typedef cub::BlockLoad<{{base_vis_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadBVIS;
{%- endif %}

{%- if have_die2 %}
typedef cub::BlockLoad<{{die1_type}}, {{blockdimx}}, {{corrs}},
                       cub::BLOCK_LOAD_WARP_TRANSPOSE_TIMESLICED,
                       {{blockdimy}}> BlockLoadDIE2;
{%- endif %}


extern "C" __global__ void {{kernel_name}}(
{{kernel_args|join(",\n")}}
)
{
    using namespace cub;

    int row = blockDim.y*blockIdx.y + threadIdx.y;
    int chan = blockDim.x*blockIdx.x + threadIdx.x;

    // Guard
    // row >= nrow || chan >= nchan
    if(row >= {{nrow}} || chan >= {{nchan}})
        { return; }

    // Shared memory (unioned) for loads
    __shared__ union {
        {%- if have_dde1 %}
        typename BlockLoadDDE1::TempStorage dde1;
        {%- endif %}

        {%- if have_coh %}
        typename BlockLoadCOH::TempStorage coh;
        {%- endif %}

        {%- if have_dde2 %}
        typename BlockLoadDDE2::TempStorage dde2;
        {%- endif %}

        {%- if have_die1 %}
        typename BlockLoadDIE1::TempStorage die1;
        {%- endif %}

        {%- if have_base_vis %}
        typename BlockLoadBVIS::TempStorage bvis;
        {%- endif %}

        {%- if have_die2 %}
        typename BlockLoadDIE2::TempStorage die2;
        {%- endif %}
    } shared;

    int ti = time_index[row];
    int ant1 = antenna1[row];
    int ant2 = antenna2[row];

    // Declare and initialise result
    {{out_type}} vis[{{corrs}}];
    {%- for c in range(corrs) %}
    vis[{{c}}] = make_{{out_type}}(0, 0);
    {%- endfor %}

    {% if do_coherencies %}
    // Loop over nsrc
    for(int src=0; src < {{nsrc}}; ++src)
    {
        {%- if have_ddes %}
        {
            {{dde2_type}} data[{{corrs}}];
            // Load in second direction dependent effect term
            BlockLoadDDE2(shared.dde2).Load(&dde2[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
        }
        {%- endif %}

        {%- if have_coh %}
        {
            {{coh_type}} data[{{corrs}}];
            BlockLoadCOH(shared.coh).Load(&source_coh[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
        }
        {%- endif %}

        {%- if have_ddes %}
        {
            {{dde1_type}} data[{{corrs}}];
            // Load in first direction dependent effect term
            BlockLoadDDE1(shared.dde1).Load(&dde1[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
        }
        {%- endif %}
    }
    {%- endif %}

    {%- if have_dies %}
    {
        {{die2_type}} data[{{corrs}}];
        // Load in second direction dependent effect term
        BlockLoadDIE2(shared.die2).Load(&die2[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
    }
    {%- endif %}

    {%- if have_base_vis %}
    {
        {{base_vis_type}} data[{{corrs}}];
        BlockLoadBVIS(shared.bvis).Load(&base_vis[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
    }
    {%- endif %}

    {%- if have_dies %}
    {
        {{die1_type}} data[{{corrs}}];
        // Load in first direction dependent effect term
        BlockLoadDIE1(shared.die1).Load(&die1[blockIdx.x*{{blockdimx}}*{{corrs}}], data);
    }
    {%- endif %}


}

// jinja2 parameters
// dde1: {{have_dde1}} {{dde1_type}} {{dde1_ndim}}
// source_coh: {{have_coh}} {{coh_type}} {{coh_ndim}}
// have_ddes2 = {{have_dde2}}
// have_dies1 = {{have_die1}}
// have_base_vis = {{have_base_vis}}
// have_dies2 = {{have_die2}}
